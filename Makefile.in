package = @PACKAGE_NAME@
version = @PACKAGE_VERSION@
tarname = $(package)
distdir = $(tarname)-$(version)

#realname = openacd
realname = $(package)

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
localstatedir = @localstatedir@
sysconfdir = @sysconfdir@

ERL=@ERL@
ERLANG_INSTALL_LIB_DIR = @ERLANG_INSTALL_LIB_DIR@
oaerllibdir = @ERLANG_INSTALL_LIB_DIR_openacd@

oaconfdir = $(sysconfdir)/$(realname)
oalogdir = $(localstatedir)/log/$(realname)
oadbdir = $(localstatedir)/$(realname)/db
oarundir = $(localstatedir)/$(realname)/run

srcdir = @srcdir@
VPATH = @srcdir@

runuser = @runuser@

edit = sed \
  -e 's|@localstatedir[@]|$(localstatedir)|g' \
  -e 's|@sysconfdir[@]|$(sysconfdir)|g' \
  -e 's|@runuser[@]|$(runuser)|g' \
  -e 's|@ERL[@]|$(ERL)|g' \
  -e 's|@ERLANG_INSTALL_LIB_DIR[@]|$(ERLANG_INSTALL_LIB_DIR)|g'

confs = rel/files/conf/env.config rel/files/conf/sys.config
bin = rel/files/bin/openacd

all: compile $(confs) $(bin)

compile:
	REBAR_SHARED_DEPS=1 @REBAR@ compile skip_deps=true

clean:
	rebar clean skip_deps=true
	-rm -rf $(confs)
	-rm -rf $(bin)
	-rm -rf $(distdir)
	-rm -rf $(distdir).tar.gz

check:
	REBAR_SHARED_DEPS=1 @REBAR@ eunit skip_deps=true

dist: $(distdir).tar.gz

$(distdir).tar.gz: $(distdir)
	tar chof - $(distdir) | gzip -9 -c > $@
	rm -rf $(distdir)

$(distdir): FORCE
	mkdir -p $(distdir)/src
	mkdir -p $(distdir)/include
	mkdir -p $(distdir)/contrib/src
	mkdir -p $(distdir)/rel/files/bin
	mkdir -p $(distdir)/rel/files/conf
	mkdir -p $(distdir)/test # for test
	cp Makefile $(distdir)
	cp rebar.config $(distdir)/rebar.config
	cp rebar.config.script $(distdir)/rebar.config.script
	cp $(wildcard src/$(realname).app.src) $(distdir)/src
	cp $(wildcard src/*.erl) $(distdir)/src
	cp $(wildcard include/*.hrl) $(distdir)/include
	cp $(wildcard contrib/src/*.erl) $(distdir)/contrib/src
	cp $(wildcard rel/files/conf/*.in) $(distdir)/rel/files/conf
	cp $(wildcard rel/files/bin/*.in) $(distdir)/rel/files/bin
	cp $(wildcard test/*.erl) $(distdir)/test

distcheck: $(distdir).tar.gz
	gzip -cd $(distdir).tar.gz | tar xvf -
	cd $(distdir) && $(MAKE) all
	cd $(distdir) && $(MAKE) check
	cd $(distdir) && $(MAKE) clean
	rm -rf $(distdir)
	@echo "*** Package $(distdir).tar.gz is ready for distribution."

FORCE:
	-rm $(distdir).tar.gz >/dev/null 2>&1
	-rm -rf $(distdir) >/dev/null 2>&1

install: install-lib install-bin

install-lib:
	install -d $(DESTDIR)$(oaerllibdir)/ebin
	install -d $(DESTDIR)$(oaerllibdir)/include
	install -m 644 ebin/$(package).app $(DESTDIR)$(oaerllibdir)/ebin
	install -m 644 ebin/*.beam $(DESTDIR)$(oaerllibdir)/ebin
	install -m 644 include/*.hrl $(DESTDIR)$(oaerllibdir)/include

install-bin: $(confs) $(bin)
	install -d $(DESTDIR)$(bindir)
	install -m 755 $(bin) $(DESTDIR)$(bindir)
	install -d $(DESTDIR)$(oaconfdir)
	install -m 644 $(confs) $(DESTDIR)$(oaconfdir)
	install -d $(DESTDIR)$(oalogdir)
	install -d $(DESTDIR)$(oadbdir)
	install -d $(DESTDIR)$(oarundir)

$(confs) $(bin): % : %.in Makefile
	$(edit) $(srcdir)/$@.in > $@

# START Local dependency management
deps: getdeps updatedeps

getdeps:
	@REBAR@ get-deps

updatedeps:
	@REBAR@ update-deps
# END Local dependency management

.PHONY: FORCE compile dist distcheck getdeps install install-lib install-bin
